<!DOCTYPE html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="js/select2/select2.css">
<style>
body {
  font-family: "Helvetica Neue", Helvetica, sans-serif;
}
.map {
  width: 950px;
  float: left;
}
.map h1 {
  font-size: 48px;
  margin-left: 50px;
}
h1, h2, h3, p, label, option, input {
  font-weight: 300;
}
svg {
  float: left;
}
.interface {
  width: 350px;
  float: left;
  padding-top: 20px;
}
.flight-list-wrapper {
  margin: 20px 0;
  border: 1px solid lightgrey;
  box-sizing: border-box;
  height: 400px;
}
.flight-list-wrapper h3 {
  margin: 10px;
}
.flight-list-wrapper h3 small {
  margin-left: 10px;
  color: #666;
  font-size: 14px;
}
.flight-list, .flight-list-items {
  list-style: none;
  margin-bottom: 10px;
  overflow: scroll;
  padding: 0;
  height: 349px;
}
.flight-list .flight,
.flight-list-items .flight {
  padding: 10px;
}
.flight-list .flight:hover,
.flight-list-items .flight:hover{
  background-color: #eee;
}
.flight-list .flight,
.flight-list-items .flight p {
  margin: 7px 0;
}
.airport-departure,
.airport-arrival,
.times-departure span,
.times-arrival span,
.flight-num ,
.status span,
.count {
  font-weight: 500;
}
.flight-count-dest {
  min-height: 1em;
}
.select2-container {
  width: 290px;
}
.state {
  fill: lightgrey;
  stroke: #fff;
}
.airport {
  opacity: .8;
  stroke: #fff;
  stroke-width: .5px;
}
path.arc {
  pointer-events: none;
  fill: none;
  stroke: #000;
  opacity: .5;
}
</style>
</head>
<body>
<div class="map">
  <h1>flighty</h1>
  <svg id="map"></svg>
</div>
<div class="interface">
  <label>Origin:
    <select id="origin"></select>
  </label>
  <p>Destination: <span class="selected-destination"> </span> </p>
  <p class="flight-count-dest"></p>
  <div class="flight-list-wrapper">
    <h3>Flights<small>Click a destination to refine flights.</small></h3>
    <ul class="flight-list-items" style="display: none">
    <li class="flight">
        <p><span class="airport-departure"></span> to <span class="airport-arrival"></span> | Flight #<span class="flight-num"></span></p>
        <p class="times-departure">Leaving <span></span></p>
        <p class="times-arrival">Arriving <span></span></p>
        <p class="status">Status: <span></span></p>
      </li>
    </ul> 
    <ul class="flight-list">
      <li class="flight">
        <p><span class="count"></span> <span class="pluralize"></span> from <span class="airport-departure"></span> to <span class="airport-arrival"></span></span>
      </li>
    </ul>
  </div>
</div>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="js/d3.geo.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="js/select2/select2.min.js"></script>
<script>
var flightstatsId = "88693368",
    flightstatsKey = "2b087f77a7151f8283938c3df55358e1"
    flightstatsStatusBaseUrl = "http://flightstats-api.herokuapp.com/flex/flightstatus/rest/v2/json/airport/status/";

var flightCountDest = d3.select(".flight-count-dest"),
    flightList = d3.select(".flight-list"),
    flightListItems = d3.select(".flight-list-items"),
    flightListItemTemplate = flightListItems.select(".flight").remove().node();
    flightListGroupTemplate = flightList.select(".flight").remove().node();

var selectedDestination = d3.select(".selected-destination");

var format = d3.time.format("%A, %b %e at %I:%M %p"),
    iso = d3.time.format.utc("%Y-%m-%dT%H:%M:%S.%LZ");

var width = 950,
    height = 600;

var svg = d3.select("#map")
    .attr("height", height)
    .attr("width", width);

var select = d3.select("#origin");

var size = d3.scale.sqrt()
    .range([1, 20]);

var projection = d3.geo.azimuthal()
    .mode("equidistant")
    .origin([-98, 38])
    .scale(1200)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

queue()
    .defer(d3.json, "http://www.cs.middlebury.edu/~candrews/classes/infovis/data/us-states.json")
    .defer(d3.json, "data/airports/airports.json")
    .await(plot);

function plot(error, states, apts) {
  var locationByAirport = d3.map(),
      nameByIata = d3.map(),
      iatas = d3.set();
  apts.forEach(function(airport) {
    locationByAirport.set(airport.iata, [airport.longitude, airport.latitude]);
    nameByIata.set(airport.iata, airport.name);
    iatas.add(airport.iata);
  });

  var arc = d3.geo.greatArc()
    .source(function(d) { return locationByAirport.get(d.source); })
    .target(function(d) { return locationByAirport.get(d.target); });

  size.domain(d3.extent(apts, function(d) { return d.count; }));

  svg.selectAll(".state")
      .data(states.features)
    .enter().append("path")
      .attr("class", "state")
      .attr("d", path);

  var airports = svg.selectAll(".airport")
      .data(apts)
    .enter().append("circle")
      .attr("class", "airport")
      .attr("cx", function(d) { return projection([d.longitude, d.latitude])[0]; })
      .attr("cy", function(d) { return projection([d.longitude, d.latitude])[1]; })
      .attr("r", function(d) { return size(d.count); })
      .attr("fill", "steelblue")
      .sort(function(a, b) { return b.count - a.count; });

  select.selectAll("option")
      .data(apts)
    .enter().append("option")
      .attr("value", function(d) { return d.iata; })
      .text(function(d) { return d.iata + " - " + d.name; });

  var arcsGroup = svg.append("g");

  var possibleDestinations = airports;
  $("#origin").select2()
      .on("change", function() {
        var airport = $(this).val(),
            date = new Date(),
            y = date.getFullYear(),
            m = date.getMonth() + 1,
            d = date.getDate(),
            h = date.getHours();

        airports.filter(function(d) { return d.iata === airport; })
            .transition()
            .duration(250)
            .attr("fill", "green");
        airports.filter(function(d) { return d.iata !== airport; })
            .transition()
            .duration(250)
            .attr("fill", "steelblue");

        updateArcs([]);

        var statusUrl = flightstatsStatusBaseUrl + airport + "/dep/" +
                        y + "/" + m + "/" + d + "/" + h +
                        "?appId=" + flightstatsId +
                        "&appKey=" + flightstatsKey +
                        "&utc=false&numHours=6";

        possibleDestinations.on("mouseover", null).on("mouseout", null).on("click", null);
        d3.json(statusUrl, function(error, flights) {
          var destinations = d3.set(),
              links = [];

          flights = flights.flightStatuses.filter(function(flight) { return iatas.has(flight.arrivalAirportFsCode); });
          flights.forEach(function(flight) {
            var origin = flight.departureAirportFsCode,
                destination = flight.arrivalAirportFsCode;
            links.push({source: origin, target: destination});
            destinations.add(destination);
          });
          possibleDestinations = airports.filter(function(airport) {
            return destinations.has(airport.iata);
          });
          possibleDestinations.transition().duration(250).attr("fill", "red");

          flightCountDest.text(flights.length + " flights from " + airport + " in the next 6 hours.")
          updateArcs(links);
          updateFlightGroup(flights);


        });

        function updateFlightGroup(flightsData) {
          var flightsByDestination = d3.nest()
              .key(function(d) { return d.arrivalAirportFsCode; })
              .entries(flightsData);
          var flights = flightList.selectAll(".flight").data(flightsByDestination);
          flights.enter().append(function() { return flightListGroupTemplate.cloneNode(true); });
          flights.exit().remove();
          flights.select(".count").text(function(d) { return d.values.length; });
          flights.select(".pluralize").text(function(d) { return d.values.length > 1 ? "flights" : "flight"; });
          flights.select(".airport-departure").text(function(d) { return d.values[0].departureAirportFsCode; });
          flights.select(".airport-arrival").text(function(d) { return d.key; });

          flights
              .on("mouseover", mouseover)
              .on("mouseout", mouseout)
              .on("click", click);
          possibleDestinations
              .on("mouseover", mouseover)
              .on("mouseout", mouseout)
              .on("click", click);
          
          function click() {
            d3.select(".flight-list").style("display", "none");
            d3.select(".flight-list-items").style("display", null);
            var clicked = d3.select(this),
                iata = clicked.classed("flight") ? clicked.select(".airport-arrival").text() : clicked.datum().iata,
                destination = possibleDestinations.filter(function(airport) { return airport.iata === iata; });

            possibleDestinations.on("mouseover", null).on("mouseout", null).style("opacity", ".2");
            flights.on("mouseover", null).on("mouseout", null);
            destination.style("opacity", ".8");



            var flightItems = flightListItems.selectAll(".flight")
                .data(flightsData.filter(function(d){ return d.arrivalAirportFsCode === iata; }));
            
            console.log(flightItems);

            flightItems.enter().append(function() { return flightListItemTemplate.cloneNode(true); });
            flightItems.exit().remove();
            flightItems.select(".airport-departure").text(function(d) { return d.departureAirportFsCode; });
            flightItems.select(".airport-arrival").text(function(d) { return d.arrivalAirportFsCode; });
            flightItems.select(".flight-num").text(function(d) { return d.flightNumber; });
            flightItems.select(".times-departure span").text(function(d) { return format(iso.parse(d.departureDate.dateUtc)); });
            flightItems.select(".times-arrival span").text(function(d) { return format(iso.parse(d.arrivalDate.dateUtc));})
            flightItems.select(".status span").text(function(d) {return flightstatuscodes(d.status);});

            function flightstatuscodes (status){
              if (status === "S") return "On time";
              if (status === "A") return "In the air";
              if (status === "U") return "Unknown";
              if (status === "R") return "Redirected";
              if (status === "L") return "Landed";
              if (status === "D") return "Diverted";
              if (status === "C") return "Cancelled";
              if (status === "NO") return "Not Operational";
            }
          

         }; 

          function mouseover() {
            var moused = d3.select(this)
                iata = moused.classed("flight") ? moused.select(".airport-arrival").text() : moused.datum().iata; 
            possibleDestinations.filter(function(d) { return d.iata !== iata; })
                .transition().duration(100)
                .style("opacity", ".2");
            selectedDestination.text(nameByIata.get(iata));
          }

          function mouseout() {
              possibleDestinations.transition().duration(100).style("opacity", ".8");
              selectedDestination.text("")
          }
        }

        

        function updateArcs(links) {
          var arcs = arcsGroup.selectAll("path").data(links);
          arcs.enter().append("path").attr("opacity", 0).transition().duration(250).attr("opacity", 1);
          arcs.exit().attr("opacity", 1).transition().duration(250).attr("opacity", 0).remove();
          arcs
              .attr("class", "arc")
              .attr("d", function(d) { try { return path(arc(d)); } catch(e) {}; });
        }
      });
}
</script>
</body>
